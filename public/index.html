<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Neuro Change Monitor</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- face-api.js for local face/eye tracking -->
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <h1>Neuro Change Monitor</h1>
      <div class="header-controls">
        <span id="connectionStatus" class="status-badge disconnected">Disconnected</span>
        <span id="modeIndicator" class="mode-badge">Monitoring</span>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Left Panel: Video Feed -->
      <section class="video-section">
        <div class="video-container">
          <video id="webcam" autoplay playsinline muted></video>
          <canvas id="overlay" class="video-overlay"></canvas>
          <div id="signalLost" class="signal-lost hidden">
            <span class="signal-lost-icon">âš </span>
            <span>Signal Lost</span>
          </div>
        </div>

        <!-- Controls -->
        <div class="controls">
          <button id="startBtn" class="btn btn-primary">Start Monitoring</button>
          <button id="lightTestBtn" class="btn btn-secondary">Light Reflex Test</button>
          <button id="resetBtn" class="btn btn-outline" disabled>Reset Baseline</button>
        </div>

        <!-- Baseline Progress -->
        <div id="baselineProgress" class="baseline-progress hidden">
          <div class="progress-label">Establishing Baseline...</div>
          <div class="progress-bar">
            <div id="baselineBar" class="progress-fill"></div>
          </div>
        </div>
      </section>

      <!-- Right Panel: Charts & Alerts -->
      <section class="data-section">
        <!-- Current Values -->
        <div class="current-values">
          <div class="value-card">
            <span class="value-label">Left Pupil</span>
            <span id="leftPupilValue" class="value-number">--</span>
          </div>
          <div class="value-card">
            <span class="value-label">Right Pupil</span>
            <span id="rightPupilValue" class="value-number">--</span>
          </div>
          <div class="value-card">
            <span class="value-label">Symmetry</span>
            <span id="symmetryValue" class="value-number">--</span>
          </div>
          <div class="value-card">
            <span class="value-label">Confidence</span>
            <span id="confidenceValue" class="value-number">--</span>
          </div>
        </div>

        <!-- Charts -->
        <div class="charts-container">
          <div class="chart-wrapper">
            <h3>Pupil Size</h3>
            <canvas id="pupilChart"></canvas>
          </div>
          <div class="chart-wrapper">
            <h3>Face Symmetry</h3>
            <canvas id="symmetryChart"></canvas>
          </div>
        </div>

        <!-- Alerts Panel -->
        <div class="alerts-panel">
          <div class="alerts-header">
            <h3>Alerts</h3>
            <button id="ackAllBtn" class="btn btn-small" disabled>Acknowledge All</button>
          </div>
          <div id="alertsList" class="alerts-list">
            <div class="no-alerts">No active alerts</div>
          </div>
        </div>
      </section>
    </main>

    <!-- Interrogation Modal -->
    <div id="interrogationModal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Interrogation Mode</h2>
          <span id="questionProgress">Question 1 of 5</span>
        </div>

        <div class="modal-body">
          <div id="questionText" class="question-text">Loading question...</div>

          <div id="listeningIndicator" class="listening-indicator hidden">
            <div class="listening-pulse"></div>
            <span>Listening...</span>
          </div>

          <div id="transcriptDisplay" class="transcript-display hidden">
            <label>Your response:</label>
            <div id="transcript" class="transcript"></div>
          </div>

          <div id="responseTimer" class="response-timer">
            <span>Time: </span>
            <span id="timerValue">0.0s</span>
          </div>
        </div>

        <div class="modal-footer">
          <button id="skipQuestionBtn" class="btn btn-outline">Skip Question</button>
          <button id="cancelInterrogationBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Light Reflex Test Modal -->
    <div id="lightTestModal" class="modal hidden">
      <div class="modal-content modal-wide">
        <div class="modal-header">
          <h2>Pupillary Light Reflex Test</h2>
          <span id="lightTestPhase">Preparing...</span>
        </div>

        <div class="modal-body">
          <!-- Phase Icon -->
          <div id="lightTestIcon" class="light-test-icon">ðŸŒ™</div>

          <!-- Phase Name -->
          <div id="lightTestName" class="light-test-name">Baseline Measurement</div>

          <!-- Instructions -->
          <div id="lightTestInstruction" class="light-test-instruction">
            Look at the camera in a dimly lit room. Keep your eyes open and still.
          </div>

          <!-- Live Pupil Display -->
          <div class="pupil-live-display">
            <div class="pupil-eye-box">
              <span class="pupil-eye-label">Left Eye</span>
              <div class="pupil-circle-container">
                <div id="leftPupilCircle" class="pupil-circle"></div>
              </div>
              <span id="leftPupilLive" class="pupil-size-live">-- mm</span>
            </div>
            <div class="pupil-eye-box">
              <span class="pupil-eye-label">Right Eye</span>
              <div class="pupil-circle-container">
                <div id="rightPupilCircle" class="pupil-circle"></div>
              </div>
              <span id="rightPupilLive" class="pupil-size-live">-- mm</span>
            </div>
          </div>

          <!-- Progress Bar -->
          <div class="light-test-progress">
            <div class="light-test-progress-bar">
              <div id="lightTestProgressFill" class="light-test-progress-fill"></div>
            </div>
            <span id="lightTestTimer">0s</span>
          </div>

          <!-- Debug Canvas (hidden by default) -->
          <canvas id="pupilDebugCanvas" class="pupil-debug-canvas hidden"></canvas>
        </div>

        <div class="modal-footer">
          <button id="cancelLightTestBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Light Test Results Modal -->
    <div id="lightTestResultsModal" class="modal hidden">
      <div class="modal-content modal-wide">
        <div class="modal-header">
          <h2>Light Reflex Test Results</h2>
        </div>

        <div class="modal-body">
          <!-- Overall Risk -->
          <div id="plrOverallRisk" class="plr-overall-risk">
            <span class="plr-risk-label">Overall Assessment:</span>
            <span id="plrRiskLevel" class="plr-risk-level low">NORMAL</span>
          </div>

          <!-- Interpretation -->
          <div id="plrInterpretation" class="plr-interpretation"></div>

          <!-- Eye Results Grid -->
          <div class="plr-results-grid">
            <!-- Left Eye -->
            <div class="plr-eye-result">
              <h4>Left Eye</h4>
              <div class="plr-eye-status" id="leftEyeStatus">NORMAL</div>
              <div class="plr-measurements">
                <div class="plr-measurement">
                  <span class="plr-measurement-label">Baseline (dark)</span>
                  <span id="leftBaseline" class="plr-measurement-value">-- mm</span>
                </div>
                <div class="plr-measurement">
                  <span class="plr-measurement-label">With Light</span>
                  <span id="leftWithLight" class="plr-measurement-value">-- mm</span>
                </div>
                <div class="plr-measurement highlight">
                  <span class="plr-measurement-label">Constriction</span>
                  <span id="leftConstriction" class="plr-measurement-value">--%</span>
                </div>
              </div>
              <div id="leftEyeMessage" class="plr-eye-message"></div>
            </div>

            <!-- Right Eye -->
            <div class="plr-eye-result">
              <h4>Right Eye</h4>
              <div class="plr-eye-status" id="rightEyeStatus">NORMAL</div>
              <div class="plr-measurements">
                <div class="plr-measurement">
                  <span class="plr-measurement-label">Baseline (dark)</span>
                  <span id="rightBaseline" class="plr-measurement-value">-- mm</span>
                </div>
                <div class="plr-measurement">
                  <span class="plr-measurement-label">With Light</span>
                  <span id="rightWithLight" class="plr-measurement-value">-- mm</span>
                </div>
                <div class="plr-measurement highlight">
                  <span class="plr-measurement-label">Constriction</span>
                  <span id="rightConstriction" class="plr-measurement-value">--%</span>
                </div>
              </div>
              <div id="rightEyeMessage" class="plr-eye-message"></div>
            </div>
          </div>

          <!-- Clinical Reference -->
          <div class="plr-reference">
            <h4>Clinical Reference</h4>
            <div class="plr-reference-item normal">Normal: 20-40% constriction</div>
            <div class="plr-reference-item sluggish">Sluggish: 10-20% constriction</div>
            <div class="plr-reference-item fixed">Fixed/Minimal: &lt;10% constriction (concerning)</div>
          </div>

          <!-- Disclaimer -->
          <div class="plr-disclaimer">
            <strong>Disclaimer:</strong> This is a screening tool only. A fixed or non-reactive pupil can indicate stroke, brain injury, or other serious conditions. If you have concerns, seek immediate medical attention.
          </div>
        </div>

        <div class="modal-footer">
          <button id="retryLightTestBtn" class="btn btn-secondary">Test Again</button>
          <button id="closeLightTestBtn" class="btn btn-primary">Close</button>
        </div>
      </div>
    </div>

    <!-- Voice Protocol Modal -->
    <div id="voiceProtocolModal" class="modal hidden">
      <div class="modal-content modal-wide">
        <div class="modal-header">
          <h2>Clinical Voice Assessment</h2>
          <span id="voiceTaskProgress">Task 1 of 4</span>
        </div>

        <div class="modal-body">
          <!-- Task Name -->
          <div id="voiceTaskName" class="voice-task-name">Sustained Vowel /a:/</div>

          <!-- Instruction -->
          <div id="voiceInstruction" class="voice-instruction">
            Take a deep breath, then say "ahhh" in a comfortable pitch and hold it as long as you can.
          </div>

          <!-- Reading Passage (shown only for reading task) -->
          <div id="readingPassageContainer" class="reading-passage-container hidden">
            <p id="readingPassage" class="reading-passage"></p>
          </div>

          <!-- Audio Level Visualizer -->
          <div class="audio-visualizer-container">
            <canvas id="audioVisualizer" width="400" height="60"></canvas>
            <div class="audio-level-bar">
              <div id="audioLevelFill" class="audio-level-fill"></div>
            </div>
          </div>

          <!-- Recording Indicator -->
          <div id="voiceRecordingIndicator" class="voice-recording-indicator hidden">
            <div class="recording-pulse"></div>
            <span>Recording...</span>
          </div>

          <!-- Countdown Display -->
          <div id="voiceCountdown" class="voice-countdown hidden">
            <span id="countdownNumber">3</span>
          </div>

          <!-- Timer -->
          <div id="voiceTimer" class="voice-timer">
            <span>Time: </span>
            <span id="voiceTimerValue">0.0s</span>
            <span id="voiceTimerMax"> / 10s</span>
          </div>
        </div>

        <div class="modal-footer">
          <button id="skipVoiceTaskBtn" class="btn btn-outline">Skip Task</button>
          <button id="cancelVoiceProtocolBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Summary Modal -->
    <div id="summaryModal" class="modal hidden">
      <div class="modal-content modal-wide">
        <div class="modal-header">
          <h2>Assessment Summary</h2>
        </div>

        <div class="modal-body">
          <div id="summaryContent" class="summary-content">
            <!-- Summary will be populated dynamically -->
          </div>

          <!-- Voice Biomarkers Section -->
          <div id="voiceBiomarkersSection" class="voice-biomarkers-section hidden">
            <h3>Voice Biomarker Analysis</h3>

            <!-- UPDRS Score Display -->
            <div class="updrs-score-display">
              <span class="updrs-label">UPDRS Speech Score:</span>
              <span id="updrsScore" class="updrs-value">0</span>
              <span id="updrsLabel" class="updrs-level">Normal</span>
            </div>

            <!-- Clinical Interpretation -->
            <div id="clinicalInterpretation" class="clinical-interpretation"></div>

            <!-- Biomarker Grid -->
            <div class="biomarker-grid">
              <div class="biomarker-card">
                <span class="biomarker-name">Jitter</span>
                <span id="jitterValue" class="biomarker-value">--</span>
                <span class="biomarker-unit">%</span>
                <span class="biomarker-threshold">&lt;1.04% healthy</span>
              </div>
              <div class="biomarker-card">
                <span class="biomarker-name">Shimmer</span>
                <span id="shimmerValue" class="biomarker-value">--</span>
                <span class="biomarker-unit">%</span>
                <span class="biomarker-threshold">&lt;3.81% healthy</span>
              </div>
              <div class="biomarker-card">
                <span class="biomarker-name">HNR</span>
                <span id="hnrValue" class="biomarker-value">--</span>
                <span class="biomarker-unit">dB</span>
                <span class="biomarker-threshold">&gt;20 dB healthy</span>
              </div>
              <div class="biomarker-card">
                <span class="biomarker-name">Syllable Rate</span>
                <span id="syllableRateValue" class="biomarker-value">--</span>
                <span class="biomarker-unit">Hz</span>
                <span class="biomarker-threshold">5-7 Hz healthy</span>
              </div>
              <div class="biomarker-card">
                <span class="biomarker-name">Pitch Range</span>
                <span id="pitchRangeValue" class="biomarker-value">--</span>
                <span class="biomarker-unit">Hz</span>
                <span class="biomarker-threshold">&gt;50 Hz healthy</span>
              </div>
              <div class="biomarker-card">
                <span class="biomarker-name">Speech Rate</span>
                <span id="speechRateValue" class="biomarker-value">--</span>
                <span class="biomarker-unit">wpm</span>
                <span class="biomarker-threshold">&gt;120 wpm healthy</span>
              </div>
            </div>

            <!-- Voice Indicators -->
            <div id="voiceIndicators" class="voice-indicators"></div>
          </div>

          <div class="summary-json">
            <h4>Raw JSON</h4>
            <pre id="summaryJson"></pre>
          </div>
        </div>

        <div class="modal-footer">
          <button id="closeSummaryBtn" class="btn btn-primary">Return to Monitoring</button>
          <button id="exportSummaryBtn" class="btn btn-outline">Export JSON</button>
        </div>
      </div>
    </div>

    <!-- Dashboard Panel (collapsible) -->
    <aside id="dashboardPanel" class="dashboard-panel collapsed">
      <button id="toggleDashboard" class="dashboard-toggle">
        <span>Dashboard</span>
        <span class="toggle-icon">â–¶</span>
      </button>
      <div class="dashboard-content">
        <div class="dashboard-stat">
          <span class="stat-label">Uptime</span>
          <span id="dashUptime" class="stat-value">--</span>
        </div>
        <div class="dashboard-stat">
          <span class="stat-label">Analyses</span>
          <span id="dashAnalyses" class="stat-value">0</span>
        </div>
        <div class="dashboard-stat">
          <span class="stat-label">Avg Latency</span>
          <span id="dashLatency" class="stat-value">--</span>
        </div>
        <div class="dashboard-stat">
          <span class="stat-label">Total Alerts</span>
          <span id="dashAlerts" class="stat-value">0</span>
        </div>
        <div class="dashboard-stat">
          <span class="stat-label">Avg Ack Time</span>
          <span id="dashAckTime" class="stat-value">--</span>
        </div>
        <div class="dashboard-stat">
          <span class="stat-label">Errors</span>
          <span id="dashErrors" class="stat-value">0</span>
        </div>
      </div>
    </aside>
  </div>

  <!-- Audio element for TTS playback -->
  <audio id="audioPlayer" style="display: none;"></audio>

  <!-- Scripts -->
  <script src="https://unpkg.com/meyda@5.6.5/dist/web/meyda.min.js"></script>
  <script src="charts.js"></script>
  <script src="face-tracker.js"></script>
  <script src="pupil-detector.js"></script>
  <script src="voice-analyzer.js"></script>
  <script src="voice-protocol.js"></script>
  <script src="app.js"></script>
</body>
</html>
